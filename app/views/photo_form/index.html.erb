<!DOCTYPE html>
<html>
<head>
  <title>YFU Photo Uploader</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-beta.3/css/select2.min.css" />
  <style>
      .bs-callout {
          padding: 20px;
          margin: 20px 0;
          border: 1px solid #eee;
          border-left-width: 5px;
          border-radius: 3px;
      }

      .bs-callout h4 {
          margin-top: 0;
          margin-bottom: 5px;
      }

      .bs-callout p:last-child {
          margin-bottom: 0;
      }

      .bs-callout code {
          border-radius: 3px;
      }

      .bs-callout + .bs-callout {
          margin-top: -5px;
      }

      .bs-callout-default {
          border-left-color: #777;
      }

      .bs-callout-default h4 {
          color: #777;
      }

      .bs-callout-primary {
          border-left-color: #428bca;
      }

      .bs-callout-primary h4 {
          color: #428bca;
      }

      .bs-callout-success {
          border-left-color: #5cb85c;
      }

      .bs-callout-success h4 {
          color: #5cb85c;
      }

      .bs-callout-danger {
          border-left-color: #d9534f;
      }

      .bs-callout-danger h4 {
          color: #d9534f;
      }

      .bs-callout-warning {
          border-left-color: #f0ad4e;
      }

      .bs-callout-warning h4 {
          color: #f0ad4e;
      }

      .bs-callout-info {
          border-left-color: #5bc0de;
      }

      .bs-callout-info h4 {
          color: #5bc0de;
      }
      /* Styling for Select2 with error */
      div.has-error .select2-selection {
          border-color: #d9534f !important;
      }

      div.has-success .select2-selection {
          border-color: #5cb85c !important;
      }
  </style>
</head>
<body>
<div class="container">

  <div class="page-header">
    <div class="row">
      <div class="col-md-1">
        <%= image_tag 'logo.png', alt: 'YFU Photo Uploader' %>
      </div>
      <div class="col-md-11">
        <h1>YFU Photo Upload
          <small></small>
        </h1>
      </div>
    </div>
  </div>
  <p>Please only upload photos of which you own the copyright, i.e. photos that you photographed yourself or if the
    copyright has been transferred to you.<br/>
  </p>

  <p>You can upload 3 photos at a time. Please identify who you are and provide us with details about the content of
    each photo.<br/>
  </p><br/>

  <div class="row">
    <div class="form-group col-md-4">
      <label for="name">Your full name</label>
      <input id="name" type="text" name="name" class="form-control name" placeholder="fe: Rachel Andresen" required/>
      <div class="alert alert-danger" role="alert" style="display:none;">
        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
        <span class="sr-only">Error:</span>
        Enter your name
      </div>
    </div>
    <div class="form-group col-md-4">
      <label for="email">Your email</label>
      <input id="email" type="email" name="email" class="form-control email" placeholder="fe: randresen@mail.com" required/>
      <div class="alert alert-danger" role="alert" style="display:none;">
        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
        <span class="sr-only">Error:</span>
        Enter a valid email
      </div>
    </div>
    <div class="form-group col-md-4">
      <label for="group">Your YFU organization's name</label>
      <br/>
      <select id="group" name="organization" class="form-control org selector" data-placeholder="Select a YFU organization">
        <option></option>
      </select>
      <div class="alert alert-danger" role="alert" style="display:none;">
        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
        <span class="sr-only">Error:</span>
        Pick an organization
      </div>
    </div>
  </div>
  <br/>
  <div id="forms">

  </div>
  <button id="add-more" class="btn btn-default">Add another photo</button>
  <div class="row">
    <div class="col-md-12">
      <div class="bs-callout bs-callout-info col-md-12">
        <h4><strong>Please note</strong></h4>

        <p><strong>By uploading photos you are giving YFU International Educational Services, and all organizations
          that use the YFU trademark, permission to use these files in all publications (e.g. web and print) for YFU
          purposes.<br/>
          You bear the responsibility to make sure that everyone depicted in your photos has agreed to publication of
          the photo.</strong></p>

        <div class="checkbox">
          <label>
            <input id="agree" name="agree" type="checkbox" required/> I agree to these terms.
          </label>
          <div class="alert alert-danger" role="alert" style="display:none;">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Error:</span>
            Please agree to the terms to upload
          </div>
        </div>
      </div>
    </div>
  </div>
  <br/>
  <input type="submit" id="upload" name="submit" class="btn btn-primary" value="Upload pictures"/>
  <div class="row">
    <div class="col-md-12">
      <hr>
      <p class="small"> @ YFU International Educational Services Inc</p>
    </div>
  </div>

</div>
<div id="form-template" class="panel panel-default" style="display:none;">
  <form role="form" action="upload_photo" method="post" class="panel-body">
    <h3>
      <span class="glyphicon glyphicon-upload"></span> Photo
      <span class="glyphicon glyphicon-remove-circle pull-right remove-photo" style="color:rgba(255, 113, 100, 0.71);cursor:hand;"></span>
    </h3>
    <div class="progress" style="display:none">
      <div class="progress-bar" style="width:0">0%</div>
    </div>
    <div class="row">

      <div class="form-group col-md-8">
        <label for="file">Select your photo</label>
        <br/>
        <span class="btn btn-primary fileinput-button">
            <i class="glyphicon glyphicon-plus"></i>
            <span>Add photo</span>
            <!-- The file input field used as target for the file upload widget -->
            <input accept="image/*" id="file" type="file" name="file" class="file" style="opacity:0;position:absolute;left:0;right:0;top:0;bottom:0;" required>
        </span>
        <div class="alert alert-danger" role="alert" style="display:none;">
          <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
          <span class="sr-only">Error:</span>
          No photo selected
        </div>
      </div>
    </div>

    <div class="row">

      <div class="form-group col-md-4">
        <label for="caption">Photo caption</label>
        <input id="caption" type="text" name="caption" class="form-control caption"/>
      </div>
      <div class="form-group col-md-4">
        <label for="country">Country where the photo was taken</label>
        <br/>
        <select id="country" name="country" class="form-control country selector" data-placeholder="Select a country">
          <option></option>
        </select>
        <div class="alert alert-danger" role="alert" style="display:none;">
          <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
          <span class="sr-only">Error:</span>
          Please select a country
        </div>
      </div>


      <div class="form-group col-md-4">
        <label for="year">Year the photo was taken</label>
        <select id="year" name="year" class="form-control year" required></select>
      </div>
    </div>

    <div class="row">
      <div class="form-group col-md-4">
        <label for="people">The names of the people in your picture</label>
        <input id="people" type="text" name="people" class="form-control people" placeholder="fe: AndrÃ© Bozere, Anton Kan" required/>
      </div>

      <div class="form-group col-md-4">
        <label for="keywords">Keywords for the photos</label>
        <br/>
        <select id="keywords" name="keywords" multiple class="form-control keywords selector" data-placeholder="Select keywords" data-tags="true">
          <option></option>
        </select>
      </div>

    </div>


    <div class="row">
      <div class="col-md-2">
        <label>Categories</label>
      </div>
    </div>
    <div class="row categories">
    </div>
  </form>
</div>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.0-beta.3/js/select2.min.js"></script>
<%= javascript_include_tag 'jQuery-File-Upload/vendor/jquery.ui.widget',
                           'jQuery-File-Upload/jquery.iframe-transport',
                           'jQuery-File-Upload/jquery.fileupload',
                           'photo_form' %>
<script>
    var api = (function(){
        var organizations,
                countries,
                keywords,
                categories;
        this.getOrganizations=function(cback){
            if(organizations) {
                cback(organizations);
            }else{
                $.getJSON('/api/yfu_organizations',function(data){
                    organizations=data;
                    cback(data);
                })
            }
        };
        this.getCountries=function(cback){
            if(countries) {
                cback(countries);
            }else{
                $.getJSON('/api/countries',function(data){
                    countries=data;
                    cback(data);
                })
            }
        };
        this.getKeywords=function(cback){
            if(keywords) {
                cback(keywords);
            }else{
                $.getJSON('/api/keywords',function(data){
                    keywords=data;
                    cback(data);
                })
            }
        };
        this.getCategories=function(cback){
            if(categories) {
                cback(categories);
            }else{
                $.getJSON('/api/categories',function(data){
                    categories=data;
                    cback(data);
                })
            }
        };
        return this;
    })();
</script>
<script>
    (function(api){
        var i = 1,
                $template = $('#form-template'),
                $forms = $('#forms'),
                $name = $('.name'),
                $email = $('.email'),
                $org = $('.org'),
                $addMore = $('#add-more'),
                $agree = $('#agree'),
                $upload = $('#upload'),
                forms = [],
                formsAreValid = false,
            photoForm = function(id){
                var self = this,
                        $form = $template.clone(),
                        $progressBar = $form.find('.progress .progress-bar'),
                        $file = $form.find('.file'),
                        $caption = $form.find('.caption'),
                        $country = $form.find('.country'),
                        $year = $form.find('.year'),
                        $people = $form.find('.people'),
                        $keywords = $form.find('.keywords'),
                        $categories = $form.find('.categories'),
                        $removePhoto = $form.find('.remove-photo');
                this.id = id;
                this.values = {};
                $form.attr('id','photo-form'+id);
                $form.addClass('photo-form');

                $.each([$file,$caption,$country,$year,$people,$keywords],function(index,item){
                    formatIdAndLabel(item);
                });

                (function initFileUpload(){
                    $file.fileupload({
                        dataType: 'json',
                        autoUpload: false,
                        acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                        add: function (e, data) {
                            self.upload=function(){
                                $country.select2('enable',false);
                                $keywords.select2('enable',false);
                                $progressBar.parent().show();
                                data.submit();
                            };
                        },
                        progress: function (e, data) {
                            var progress = parseInt(data.loaded / data.total * 100, 10)+"%";
                            $progressBar.css(
                                    'width',
                                    progress
                            );
                            $progressBar.text(progress);
                        },
                        done: function(e, data){

                        },
                        fail: function(e, data){

                        }
                    }).bind('fileuploadsubmit', function (e, data) {
                        data.formData = self.values;
                    });
                })();

                $removePhoto.click(function(){
                    $form.remove();
                    $.each(forms,function(index,element){
                        if(element&&element.id==id){
                            forms.splice(index,1);
                        }
                    });
                });
                function formatIdAndLabel($el){
                    var oldId = $el.attr('id'),
                            elId = oldId+id,
                            $parent;

                    $parent = $el.parent();
                    if(oldId=='file'){
                        $parent = $parent.parent();
                    }
                    $parent.find('label').attr('for',elId);
                    $el.attr('id',elId);
                }
                this.validate = function(){
                    self.getValues();
                    var values = self.values;
                    self.valid = true;
                    if(!values.country){
                        self.valid = false;
                        makeInvalid($country);
                    }else{
                        makeValid($country);
                    }
                    if(!$file[0].files||$file[0].files.length!=1){
                        self.valid=false;
                        makeInvalid($file);
                    }else{
                        makeValid($file);
                    }
                    if(self.valid){
                        $form.addClass('panel-success');
                        $form.removeClass('panel-danger');
                    }else{
                        $form.addClass('panel-danger');
                        $form.removeClass('panel-success');
                    }
                    return self.valid;
                };
                this.getValues=function(){
                    self.values.name = $name.val();
                    self.values.email = $email.val();
                    self.values.organization = $org.val();
                    self.values.caption = $caption.val();
                    self.values.country = $country.val();
                    self.values.year = $year.val();
                    self.values.people = $people.val();
                    self.values.keywords = $keywords.val();
                    self.values.categories=$categories.find('input:checkbox:checked').map(function() {return this.value;}).get();
                };
                $form.appendTo($forms);
                //$form.css("opacity",0).show();
                $form.fadeIn();

                (function initSelect2Fields(){
                    $form.find('.selector').select2();
                })();
                return this;
            };
        $addMore.click(addForm);
        function addForm(){
            forms.push(new photoForm(i));
            i++;
        }
        $upload.click(function(event){
            var i2,form;
            formsAreValid=true;
            for(i2=0;i2<forms.length;i2++) {
                form = forms[i2];
                if (!form.validate()) {
                    formsAreValid = false;
                }
                if (!form.values.name && form.values.name.length < 2) {
                    formsAreValid = false;
                    makeInvalid($name);
                } else {
                    makeValid($name);
                }
                if (!new RegExp('^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$', 'i').test(form.values.email)) {
                    formsAreValid = false;
                    makeInvalid($email);
                } else {
                    makeValid($email);
                }
                if (!form.values.organization) {
                    formsAreValid = false;
                    makeInvalid($org);
                } else {
                    makeValid($org);
                }
                var parent = $agree.closest('div');
                if (!$agree.prop('checked')) {
                    formsAreValid = false;
                    parent.removeClass('has-success');
                    parent.addClass('has-error');
                    parent.find('.alert').show('fast');
                } else {
                    parent.addClass('has-success');
                    parent.removeClass('has-error');
                    parent.find('.alert').hide('fast');
                }
            }
            if(formsAreValid){
                for(i2=0;i2<forms.length;i2++){
                    form = forms[i2];
                    $('input').attr('readonly','readonly');
                    $('select').attr('readonly','readonly');
                    $('.selector').select2('enable',false);
                    form.upload();
                }
            }
        });
        (function initData(templateReadyCback){
            var countriesLoaded=false,
                    keywordsLoaded=false,
                    categoriesLoaded=false;
            api.getOrganizations(function(orgs){
                var html = '';
                $.each(orgs,function(index,org){
                    html+='<option value"'+org.name+'">'+org.name+'</option>';
                });
                $(html).appendTo($org);
                $org.select2();
            });
            api.getCountries(function(countries){
                var html = '';
                $.each(countries,function(index,country){
                    html+='<option value"'+country.name+'">'+country.name+'</option>';
                });
                $(html).appendTo($template.find('.country'));
                countriesLoaded=true;
                checkCallback();
            });
            api.getKeywords(function(keywords){
                var html = '';
                $.each(keywords,function(index,keyword){
                    html+='<option value"'+keyword.word+'">'+keyword.word+'</option>';
                });
                $(html).appendTo($template.find('.keywords'));
                keywordsLoaded=true;
                checkCallback();
            });
            api.getCategories(function(categories){
                var html = '';
                $.each(categories,function(index,category){
                    html+='<div class="col-sm-2"><label><input name="categories[]" class="category" type="checkbox" value="'+category.name+'"/> '+category.name+' </label></div>';
                });
                $(html).appendTo($template.find('.categories'));
                categoriesLoaded=true;
                checkCallback();
            });
            (function addYears(){
                var currentYear = new Date().getFullYear(),
                        year,
                        html='';
                for(year=1951;year<=currentYear;year++){
                    html+='<option value"'+year+'">'+year+'</option>'
                }
                $(html).appendTo($template.find('.year'));
            })();
            function checkCallback(){
                if(countriesLoaded&&keywordsLoaded&&categoriesLoaded){
                    templateReadyCback();
                }
            }
        })(
                function () {
                    addForm();
                }
        );
        function makeValid($el){
            var formGroup = $el.closest('.form-group');
            formGroup.addClass('has-success');
            formGroup.removeClass('has-error');
            formGroup.find('.alert').hide('fast');
        }
        function makeInvalid($el){
            var formGroup = $el.closest('.form-group');
            formGroup.removeClass('has-success');
            formGroup.addClass('has-error');
            formGroup.find('.alert').show('fast');
        }
    })(api);

</script>
</body>
</html>
